#!/usr/bin/env ruby

require "erb"
require "rdoc/rdoc"
require "rdoc/generator"

class RDoc::Generator::Tynn
  RDoc::RDoc.add_generator(self)

  TEMPLATE = DATA.read
  LAYOUT = File.read(File.expand_path("../layout.html", __dir__))

  TITLE = "TITLE".freeze
  CONTENT = "m4_include(CONTENT)".freeze

  def initialize(store, options)
    @classes = store.all_classes_and_modules.sort
  end

  def generate
    @classes.each do |klass|
      output = LAYOUT.gsub(TITLE, klass.full_name)
      output = output.gsub(CONTENT, render(klass))

      File.write(classfile(klass), output)
    end
  end

  private

  def render(klass)
    return renderer.result(binding)
  end

  def renderer
    return @renderer ||= ERB.new(TEMPLATE)
  end

  def classfile(klass)
    return sprintf("%s.html", klass.full_name.gsub("::", "-"))
  end

  public def class_dir; end # required by RDoc
end

rdoc = RDoc::RDoc.new

rdoc.document([
  *ARGV,
  "--markup", "markdown",
  "-q", "-f", "tynn"
])

__END__
<h1><%= klass.full_name %></h1>
<p><%= klass.description %></p>

<% klass.methods_by_type.each do |type, visibilities| %>
  <% next if visibilities.empty? %>
  <% visibilities.each do |visibility, methods| %>
    <% next if methods.empty? %>

    <h2>
      <%= visibility.to_s.capitalize %>
      <%= type.capitalize %>
      methods
    </h2>

    <% methods.each do |method| %>
      <% next if method.is_alias_for %>

      <h3 id="<%= method.aref %>">
        <% if method.call_seq %>
          <%= method.call_seq.strip %>
        <% else %>
          <%= method.name %><%= method.params %>
        <% end %>
      </h3>

      <% if method.comment %>
        <p><%= method.description.strip %></p>
      <% end %>
    <% end %>
  <% end %>
<% end %>
